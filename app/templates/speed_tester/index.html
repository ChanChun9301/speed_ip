{% extends "layouts.html" %}
{% load static %}

{% block content %}
<div class="min-h-screen flex items-center justify-center px-6 py-4">
    <div class="w-full max-w-5xl">

        <!-- Главная карточка — чистый премиум glassmorphism -->
        <div class="glass rounded-3xl p-4 md:p-14 shadow-2xl border border-white/10 neon-glow">
            
            <!-- Заголовок -->
            <div class="text-center mb-12">
                <h1 class="text-5xl md:text-7xl font-black text-gradient tracking-tight">
                    Google Dork Builder
                </h1>
                <p class="mt-6 text-xl text-gray-300 max-w-3xl mx-auto leading-relaxed">
                    Ýöriteleşdirilen Google gözleg soraglaryny dörediň — güýçli operatorlar we açar sözler bilen
                </p>
            </div>

            <!-- Кнопка "Komandalar" -->
            <div class="text-center mb-mb-10">
                <a href="{% url 'com_list' %}" class="inline-flex items-center gap-3 px-8 py-4 glass border border-white/20 rounded-2xl text-lg font-medium hover:border-[#92DEB5]/50 hover:bg-white/5 transition-all duration-400 hover:scale-105">
                    <i class="fas fa-book-open text-[#92DEB5]"></i>
                    Dork komandalaryny görmek
                </a>
            </div>

            <!-- Динамические поля ввода -->
            <div id="inputContainer" class="space-y-5 mb-10"></div>

            <!-- Кнопки управления -->
            <div class="flex flex-wrap justify-center gap-5 mb-10">
                <button id="addButton" class="flex items-center gap-3 px-8 py-5 bg-white/10 hover:bg-white/20 border border-white/20 rounded-2xl font-bold text-lg backdrop-blur hover:border-[#92DEB5]/60 transition-all hover:scale-105 hover:shadow-xl">
                    <i class="fas fa-plus"></i> Goşmak
                </button>
                <button id="collectButton" class="flex items-center gap-4 px-10 py-5 bg-gradient-to-r from-[#92DEB5] to-[#6ab88a] text-black font-bold text-xl rounded-2xl shadow-xl hover:shadow-[#92DEB5]/50 transition-all hover:scale-110">
                    <i class="fas fa-search"></i> Gözleg URL-ny döretmek
                </button>
            </div>

            <!-- Результат -->
            <div id="outputContainer" class="hidden space-y-6 animate__animated animate__fadeIn">
                <div class="p-6 bg-black/30 backdrop-blur-xl rounded-2xl border border-[#92DEB5]/30 neon-glow">
                    <div class="flex items-center gap-4">
                        <i class="fas fa-link text-[#92DEB5] text-2xl"></i>
                        <input type="text" id="output" readonly 
                               class="w-full px-5 py-4 bg-transparent border-0 text-[#92DEB5] font-mono text-lg focus:outline-none">
                    </div>
                </div>

                <div class="flex flex-wrap justify-center gap-5">
                    <button id="copyButton" class="px-10 py-5 glass border border-white/30 rounded-2xl font-bold text-lg hover:bg-white/10 hover:border-[#92DEB5] transition-all hover:scale-105">
                        <i class="fas fa-copy mr-3"></i> Kopiýa etmek
                    </button>
                    <a id="openButton" target="_blank" class="px-12 py-5 bg-gradient-to-r from-[#92DEB5] to-[#6ab88a] text-black font-bold text-xl rounded-2xl shadow-xl hover:shadow-[#92DEB5]/60 transition-all hover:scale-110">
                        <i class="fab fa-google mr-3"></i> Google-da açmak
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const inputContainer = document.getElementById('inputContainer');
    const addButton = document.getElementById('addButton');
    const collectButton = document.getElementById('collectButton');
    const outputContainer = document.getElementById('outputContainer');
    const outputInput = document.getElementById('output');
    const copyButton = document.getElementById('copyButton');
    const openButton = document.getElementById('openButton');

    // Получаем команды с сервера
    async function fetchCommands() {
        try {
            const res = await fetch('/api/commands/');
            const data = await res.json();
            return data.commands || [];
        } catch (err) {
            console.error('Komandalar ýüklenmedi:', err);
            return [];
        }
    }

    async function populateSelect(select) {
        const commands = await fetchCommands();
        const placeholder = document.createElement('option');
        placeholder.value = ''; 
        placeholder.textContent = 'Komanda saýlaň'; 
        placeholder.disabled = true; 
        placeholder.selected = true;
        select.appendChild(placeholder);

        commands.forEach(cmd => {
            const opt = document.createElement('option');
            opt.value = cmd.dork_command;
            opt.textContent = cmd.dork_command;
            opt.title = cmd.description || '';
            select.appendChild(opt);
        });
    }

    function populateOperatorSelect(select) {
        const ops = [' ', 'OR', '&', '|', '+', '-'];
        const placeholder = document.createElement('option');
        placeholder.value = ' '; 
        placeholder.textContent = 'Operator'; 
        placeholder.disabled = true; 
        placeholder.selected = true;
        select.appendChild(placeholder);

        ops.forEach(op => {
            select.add(new Option(op || '(пробел)', op));
        });
    }

    // Добавление новой строки
    addButton.addEventListener('click', async () => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-1 md:grid-cols-12 gap-4 p-5 bg-white/5 rounded-2xl border border-white/10 hover:border-[#92DEB5]/30 transition-all';

        const cmdSelect = document.createElement('select');
        cmdSelect.className = 'md:col-span-3 px-5 py-4 bg-black/40 border border-white/20 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-[#92DEB5]/50';
        await populateSelect(cmdSelect);

        const text1 = document.createElement('input');
        text1.type = 'text';
        text1.placeholder = 'Deňeşdirme (mysal: pdf)';
        text1.className = 'md:col-span-3 px-5 py-4 bg-black/40 border border-white/20 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#92DEB5]/50';

        const opSelect = document.createElement('select');
        opSelect.className = 'md:col-span-2 px-5 py-4 bg-black/40 border border-white/20 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-[#92DEB5]/50';
        populateOperatorSelect(opSelect);

        const text2 = document.createElement('input');
        text2.type = 'text';
        text2.placeholder = 'Açar söz / domen';
        text2.className = 'md:col-span-3 px-5 py-4 bg-black/40 border border-white/20 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#92DEB5]/50';

        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '<i class="fas fa-trash-alt text-red-400"></i>';
        removeBtn.className = 'md:col-span-1 flex items-center justify-center px-5 py-4 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 rounded-xl transition-all hover:scale-110';
        removeBtn.onclick = () => row.remove();

        row.append(cmdSelect, text1, opSelect, text2, removeBtn);
        inputContainer.appendChild(row);

        text1.focus();
    });

    // Главная кнопка — сборка запроса
    collectButton.addEventListener('click', async () => {
        const rows = inputContainer.querySelectorAll('div.grid');
    
        const textInputs = [];
        const dorkCommands = [];
        const queryParts = [];
    
        rows.forEach(row => {
            const cmd  = row.children[0].value.trim();  // dork
            const val  = row.children[1].value.trim();  // text input
            const op   = row.children[2].value || '';   // operator
            const term = row.children[3].value.trim();  // next term
    
            dorkCommands.push(cmd || "");
            textInputs.push(val || "");
    
            let part = "";
    
            if (cmd && val)       part = `${cmd}:${val}`;
            else if (val)         part = val;
    
            if (term) {
                if (part) part += op + term;
                else part = term;
            }
    
            if (part) queryParts.push(part);
        });
    
        // Сбор финального гугл‑дока
        const finalQuery = queryParts.join(" ").trim();
        const googleUrl = "https://www.google.com/search?q=" + encodeURIComponent(finalQuery);
    
        // Сохранение истории dorkов
        try {
            await fetch("/save_search/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")?.value ||
                                   document.cookie.match(/csrftoken=([^;]+)/)?.[1] ||
                                   ""
                },
                body: new URLSearchParams({
                    full_query: finalQuery,
                    text_inputs: JSON.stringify(textInputs),
                    dork_commands: JSON.stringify(dorkCommands)
                })
            });
        } catch (e) {
            console.warn("Gözleg taryhy ýazylmady:", e);
        }
    
        // UI вывод результата
        outputInput.value = googleUrl;
        openButton.href = googleUrl;
        outputContainer.classList.remove("hidden");
    });
    

    // Копирование
    copyButton.addEventListener('click', () => {
        outputInput.select();
        document.execCommand('copy');
        const oldHTML = copyButton.innerHTML;
        copyButton.innerHTML = '<i class="fas fa-check mr-3"></i> Kopiýa edildi!';
        setTimeout(() => copyButton.innerHTML = oldHTML, 2000);
    });
</script>   
{% endblock %}