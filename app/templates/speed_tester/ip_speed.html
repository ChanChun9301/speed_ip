{% extends "layouts.html" %}
{% load static %}

{% block content %}
<div class="min-h-screen flex items-center justify-center px-6 py-24">
    <div class="w-full max-w-4xl">

        <!-- Главная карточка -->
        <div class="glass rounded-3xl p-2xl p-10 md:p-16 shadow-2xl border border-white/10 neon-glow">

            <!-- Заголовок -->
            <div class="text-center mb-14">
                <h1 class="text-6xl md:text-8xl font-black text-gradient tracking-tight">
                    Tor Tizligi Synagy
                </h1>
                <p class="mt-6 text-2xl text-gray-300">
                    Häzirki Tor ulgamy arkaly internet tizligiňizi synap görüň
                </p>
            </div>

            <!-- Индикатор состояния -->
            <div id="status" class="text-center mb-12">
                <p class="text-xl text-gray-400" id="statusText">Synag başlaň...</p>
                <div class="mt-6 flex justify-center">
                    <div class="w-32 h-32 rounded-full border-8 border-white/10 border-t-[#92DEB5] animate-spin" id="spinner" hidden></div>
                </div>
            </div>

            <!-- Результаты -->
            <div id="results" class="hidden space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Ping -->
                    <div class="text-center p-8 bg-black/40 rounded-2xl border border-[#92DEB5]/30 neon-glow">
                        <i class="fas fa-stopwatch text-5xl text-[#92DEB5] mb-4"></i>
                        <p class="text-gray-400 text-lg">Ping</p>
                        <p class="text-4xl font-black text-white mt-2" id="ping">-</p>
                    </div>

                    <!-- Download -->
                    <div class="text-center p-8 bg-black/40 rounded-2xl border border-[#92DEB5]/30 neon-glow">
                        <i class="fas fa-download text-5xl text-[#92DEB5] mb-4"></i>
                        <p class="text-gray-400 text-lg">Ýüklemek (Download)</p>
                        <p class="text-4xl font-black text-white mt-2" id="download">-</p>
                    </div>

                    <!-- Upload -->
                    <div class="text-center p-8 bg-black/40 rounded-2xl border border-[#92DEB5]/30 neon-glow">
                        <i class="fas fa-upload text-5xl text-[#92DEB5] mb-4"></i>
                        <p class="text-gray-400 text-lg">Ýüklemek (Upload)</p>
                        <p class="text-4xl font-black text-white mt-2" id="upload">-</p>
                    </div>
                </div>

                <!-- Дополнительная информация -->
                <div class="mt-10 p-8 bg-white/5 rounded-2xl border border-white/10 text-center">
                    <p class="text-gray-400 mb-3">Çykyş IP (Tor):</p>
                    <code class="text-2xl font-mono text-[#92DEB5]" id="exitIp">-</code>
                </div>
            </div>

            <!-- Кнопка запуска -->
            <div class="text-center mt-14">
                <button id="startButton" class="px-16 py-7 bg-gradient-to-r from-[#92DEB5] to-[#6ab88a] text-black font-bold text-2xl rounded-full shadow-2xl hover:scale-110 hover:shadow-[#92DEB5]/70 transition-all duration-500 flex items-center gap-5 mx-auto">
                    <i class="fas fa-play text-3xl"></i>
                    Tizligi synap görmek
                </button>
            </div>

            <!-- Кнопка истории (всегда видна) -->
            <div class="text-center mt-10">
                <a href="{% url 'speed_test_history' %}" class="inline-flex items-center gap-3 px-8 py-4 glass border border-white/20 rounded-2xl text-lg font-medium hover:border-[#92DEB5]/50 hover:bg-white/5 transition-all duration-400">
                    <i class="fas fa-history text-[#92DEB5]"></i>
                    Geçmiş synaglary görmek
                </a>
                </a>
            </div>

        </div>
    </div>
</div>

<script>
    const startButton = document.getElementById('startButton');
    const statusText = document.getElementById('statusText');
    const spinner = document.getElementById('spinner');
    const results = document.getElementById('results');
    const pingEl = document.getElementById('ping');
    const downloadEl = document.getElementById('download');
    const uploadEl = document.getElementById('upload');
    const exitIpEl = document.getElementById('exitIp');

    startButton.addEventListener('click', async () => {
        // Сброс
        results.classList.add('hidden');
        spinner.hidden = false;
        statusText.textContent = 'Tor arkaly tizlik synag geçirilýär...';
        startButton.disabled = true;
        startButton.innerHTML = '<i class="fas fa-spinner fa-spin text-3xl"></i> Synag dowam edýär...';

        try {
            const response = await fetch('/api/speedtest/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                }
            });

            const data = await response.json();

            // Показ результатов
            spinner.hidden = true;
            results.classList.remove('hidden');

            pingEl.textContent = data.ping_ms === -1 ? 'Wagt gutardy' : `${data.ping_ms.toFixed(1)} ms`;

            downloadEl.textContent = data.download_speed_kbps > 1000 
                ? `${(data.download_speed_kbps / 1000).toFixed(2)} Mbps` 
                : `${data.download_speed_kbps.toFixed(0)} kbps`;

            uploadEl.textContent = data.upload_speed_kbps > 1000 
                ? `${(data.upload_speed_kbps / 1000).toFixed(2)} Mbps` 
                : `${data.upload_speed_kbps.toFixed(0)} kbps`;

            exitIpEl.textContent = data.destination_ip || 'Bilinmeýär';

            statusText.textContent = 'Synag gutardy!';
            startButton.innerHTML = '<i class="fas fa-redo text-3xl"></i> Gaýtadan synag';
            startButton.disabled = false;

        } catch (err) {
            spinner.hidden = true;
            statusText.textContent = 'Ýalňyşlyk ýüze çykdy. Tor ulanýarsyňyzmy?';
            statusText.classList.add('text-red-');
            startButton.innerHTML = '<i class="fas fa-exclamation-triangle text-3xl"></i> Gaýtadan synap görmek';
            startButton.disabled = false;
            console.error(err);
        }
    });
</script>
{% endblock %}