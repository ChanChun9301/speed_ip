# import_exploitdb.py
import os
import django
import pandas as pd
from tqdm import tqdm  # красивый прогресс-бар

# Настройка Django
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "your_project.settings")  # ← замени на свой проект
django.setup()

from app.models import ExploitExample  # ← убедись, что путь правильный

# URL к актуальному CSV от Exploit-DB
URL = "https://raw.githubusercontent.com/offensive-security/exploitdb/master/files_exploits.csv"

print("Загрузка Exploit-DB...")

try:
    df = pd.read_csv(URL)
    print(f"Успешно загружено {len(df):,} эксплойтов из Exploit-DB")
except Exception as e:
    print(f"Ошибка загрузки CSV: {e}")
    exit()

# Очистка старых данных (опционально — можно закомментировать, если хочешь дополнять)
print("Очистка старой базы ExploitExample...")
ExploitExample.objects.all().delete()

# Создаём список объектов для bulk_create — это в 50–100 раз быстрее!
objects_to_create = []

print("Импорт эксплойтов в базу (это займёт ~10–30 секунд)...")

for _, row in tqdm(df.iterrows(), total=len(df), desc="Импорт", unit="exploit"):
    # Защита от NaN и пустых значений
    exploit_id = str(row['id']) if pd.notna(row['id']) else None
    description = str(row['description']) if pd.notna(row['description']) else "No description"
    platform = str(row.get('platform', 'Unknown')).strip()
    exploit_type = str(row.get('type', 'Unknown')).strip()
    author = str(row.get('author', 'Unknown')).strip() if pd.notna(row.get('author')) else "Unknown"
    date = row.get('date', None)

    # Формируем правильную ссылку
    edb_id = exploit_id if exploit_id else "unknown"
    url = f"https://www.exploit-db.com/exploits/{edb_id}"

    objects_to_create.append(
        ExploitExample(
            edb_id=exploit_id,
            description=description[:500],  # обрезаем, если слишком длинное
            platform=platform,
            exploit_type=exploit_type,
            author=author,
            date_published=date,
            url=url,
            verified=row.get('verified', 0) == 1,
        )
    )

# Один запрос — всё заливается мгновенно
ExploitExample.objects.bulk_create(
    objects_to_create,
    batch_size=1000,  # оптимально для PostgreSQL/SQLite
    ignore_conflicts=True  # если вдруг запустишь повторно
)

print("\nExploit-DB успешно импортирован!")
print(f"Добавлено {len(objects_to_create):,} эксплойтов в базу")
print("Теперь у тебя — полная оффенсивная база знаний 2025 года")